using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Threading;
using System.IO;
using System.Security.Cryptography;

namespace Antivirus
{
    public partial class VirusCustomScanUserControl : UserControl
    {
        FolderBrowserDialog fbd = new FolderBrowserDialog();
        Thread th;
        string custom_file_path;
        int count;
        int virus = 0;
        // delegate function to update file path
        public delegate void updateFilePath(string text);
        public delegate void updateFileCount(int Count);
        public delegate void updateVirusCount(int virusCount);
        List<viruslog> loglist = new List<viruslog>();
        DataTable dt = new DataTable();
        
        public void FilePath(string filePath)
        {
            //this.file.Text = filePath;
            this.fileP.Text = filePath;
        }
        public void FileCount(int fileCount)
        {
            this.fCount.Text = fileCount.ToString();
        }
        public void VirusCount(int fileCount)
        {
            this.mCount.Text = fileCount.ToString();
        }
        public VirusCustomScanUserControl()
        {
            InitializeComponent();
            stopB.Visible = false;
            pauseB.Visible = false;
            resumeB.Visible = false;
            startB.Visible = true;
            scanStatus.Text = "Please Click Start Button to Start the Scan.";
            dt.Columns.Add("File Path");
            dt.Columns.Add("Result");

            dataGridView1.DataSource = dt;
        }
        public string Get_MD5(string file_path)
        {
            using (var md5 = MD5.Create())
            {
                using (var stream = File.OpenRead(file_path))
                {
                    return BitConverter.ToString(md5.ComputeHash(stream)).Replace("-", string.Empty);
                }

            }
        }

        public bool check_hash(string md5_hash)
        {
            bool result = false;
            var md5_hashes = File.ReadAllLines("D:\\College\\BE\\ZecurePlus\\Dataset\\virus_scan_db.txt");
            //var md5_hashes = File.ReadAllLines("D:\\College\\BE\\ZecurePlus\\Dataset\\virus_db.txt"); //anish path
            //var md5_hashes = File.ReadAllLines("D:\\Projects\\BE_Project\\ZecurePlus\\Dataset\\virus_db.txt"); //jatin path

            if (md5_hashes.Contains(md5_hash))
            {
                result = true;
            }
            return result;
        }
        private void startB_Click(object sender, EventArgs e)
        {
            //Visibility of buttons
            startB.Visible = false;
            pauseB.Visible = true;
            stopB.Visible = true;
            resumeB.Visible = false;
            scanStatus.Text = "Scanning in Progress... ";
            if (fbd.ShowDialog() == DialogResult.OK)
            {
                custom_file_path = fbd.SelectedPath;
                //Console.WriteLine(dir_path + "1");
            }

            th = new Thread(start_custom_scan);
            th.Start();
            th.IsBackground = true;
        }
        private void start_custom_scan()
        {
            count = 0;
            DirSearch_ex3(custom_file_path);
            Console.WriteLine(count);
            th.Abort();
        }

        private void DirSearch_ex3(string sDir)
        {
            try
            {
                foreach (string f in Directory.GetFiles(sDir))
                {
                    count += 1;
                    string md5_hash;
                    md5_hash = Get_MD5(f);
                    bool result = check_hash(md5_hash);
                    if (result == true)
                    {
                        virus += 1;
                        dt.Rows.Add(new object[] { f, result });
                        dataGridView1.DataSource = dt;

                        loglist.Add(new Antivirus.viruslog { fileName = f, result =  result.ToString()});
                    }
                    updateFilePath UpdateFilePath = new updateFilePath(FilePath);
                    this.file.BeginInvoke(UpdateFilePath, f);
                    updateFileCount UpdateFileCount = new updateFileCount(FileCount);
                    this.filesCount.BeginInvoke(UpdateFileCount, count);
                    updateVirusCount UpdateMalCount = new updateVirusCount(VirusCount);
                    this.malwareCount.BeginInvoke(UpdateMalCount, virus);
                }

                foreach (string d in Directory.GetDirectories(sDir))
                {
                    DirSearch_ex3(d);
                }
            }
            catch (System.Exception excpt)
            {
                Console.WriteLine(excpt.Message);
            }
        }
        private void pauseB_Click(object sender, EventArgs e)
        {
            scanStatus.Text = "The Scan has been Paused.";
            startB.Visible = false;
            resumeB.Visible = true;
            stopB.Visible = true;
            pauseB.Visible = false;
            if (th.IsAlive)
            {
                th.Suspend();
                Console.WriteLine("The Threat has been paused");
            }
            else
            {
                MessageBox.Show("No Scan in Running");
            }
        }

        private void resumeB_Click(object sender, EventArgs e)
        {
            startB.Visible = false;
            resumeB.Visible = false;
            stopB.Visible = true;
            pauseB.Visible = true;
            scanStatus.Text = "Scanning in Progress... ";
            if (th.IsAlive)
            {
                th.Resume();
                Console.WriteLine("The Threat has been resumed");
            }
            else
            {
                MessageBox.Show("No Scan in Running");
            }
        }

        public void update_json_file(int count)
        {
            Console.WriteLine(count);
            string json = File.ReadAllText("D:\\College\\BE\\ZecurePlus\\Dataset\\count.json");
            dynamic jsonObj = Newtonsoft.Json.JsonConvert.DeserializeObject(json);
            jsonObj["virus"] = count;
            string output = Newtonsoft.Json.JsonConvert.SerializeObject(jsonObj, Newtonsoft.Json.Formatting.Indented);
            File.WriteAllText("D:\\College\\BE\\ZecurePlus\\Dataset\\count.json", output);
        }

        private void stopB_Click(object sender, EventArgs e)
        {
            update_json_file(virus);
            startB.Visible = true;
            pauseB.Visible = false;
            resumeB.Visible = false;
            stopB.Visible = false;
            scanStatus.Text = "Scan has been Stopped.";
            if (th != null)
            {
                Console.WriteLine(th.ThreadState);
                if (th.ThreadState == System.Threading.ThreadState.Running || th.ThreadState == System.Threading.ThreadState.Suspended || th.ThreadState == System.Threading.ThreadState.Background || th.ThreadState == System.Threading.ThreadState.Aborted)
                {

                    DialogResult dialog = MessageBox.Show("Do you really want to stop the scan?", "Stop the Scan", MessageBoxButtons.YesNo);
                    if (dialog == DialogResult.Yes)
                    {
                        th.Abort();

                    }
                }
            }
            else
            {
                MessageBox.Show("No scan was in progress.");
            }
            fileP.Text = "";
        }

        private void label5_Click(object sender, EventArgs e)
        {

        }

        private void Status_Click(object sender, EventArgs e)
        {

        }

        private void button1_Click(object sender, EventArgs e)
        {
            update_json_file(virus);
            Form form = this.FindForm();
            stopB.Visible = false;
            pauseB.Visible = false;
            resumeB.Visible = false;
            startB.Visible = true;
            if (th != null)
            {
                Console.WriteLine(th.ThreadState);
                if (th.ThreadState == System.Threading.ThreadState.Running || th.ThreadState == System.Threading.ThreadState.Suspended || th.ThreadState == System.Threading.ThreadState.Background)
                {

                    DialogResult dialog = MessageBox.Show("Do you really want to stop the scan?", "Stop the Scan", MessageBoxButtons.YesNo);
                    if (dialog == DialogResult.Yes)
                    {
                        th.Abort();
                        form.Controls["virusProtection1"].BringToFront();
                    }
                }
                else
                {
                    form.Controls["virusProtection1"].BringToFront();
                }
            }
            else
            {
                form.Controls["virusProtection1"].BringToFront();
            }
            fileP.Text = "";
            fCount.Text = "";
            mCount.Text = "";
        }
    }

    public class viruslog : IEquatable<viruslog>
    {
        public string fileName { get; set; }
        public string result { get; set; }

        public override string ToString()
        {
            return "" + fileName + "\t\t" + result;
        }

        public bool Equals(viruslog other)
        {
            throw new NotImplementedException();
        }
    }

}
