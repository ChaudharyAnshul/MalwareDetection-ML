using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.IO;
using System.Threading;
using System.Diagnostics;
using PeNet;

namespace Antivirus
{
    public partial class FullScanUserControl : UserControl
    {
        DataTable dt = new DataTable();
        public FullScanUserControl()
        {
            InitializeComponent();
            stopButton.Visible = false;
            pauseButton.Visible = false;
            resumeButton.Visible = false;
            scanStatus.Text = "Please Click Start Button to Start the Scan.";
            dt.Columns.Add("File Path");
            dt.Columns.Add("Result");

            dataGridView1.DataSource = dt;
        }
        // delegate function to update file path

        private int count = 0;
        string py_path = "";
        Thread th;
        private int malware = 0;
        // delegate function to update file path
        public delegate void updateFilePath(string text);
        public delegate void updateFileCount(int Count);
        public delegate void updateMalwareCount(int malCount);
        private string get_py_path()
        {

            string temp_path = "";
            string path = "";
            Process cmd = new Process();
            cmd.StartInfo.FileName = "cmd.exe";
            cmd.StartInfo.RedirectStandardInput = true;
            cmd.StartInfo.RedirectStandardOutput = true;
            cmd.StartInfo.CreateNoWindow = true;
            cmd.StartInfo.UseShellExecute = false;
            cmd.Start();
            cmd.StandardInput.WriteLine("where python");
            cmd.StandardInput.Flush();
            cmd.StandardInput.Close();
            cmd.WaitForExit();
            while (!cmd.StandardOutput.EndOfStream)
            {
                string standard_output = cmd.StandardOutput.ReadLine();
                if (standard_output.Contains("python.exe"))
                {
                    temp_path = standard_output;
                    break;
                }


            }
            path = temp_path;

            return path;

        }

        private string get_header(String file_path)
        {
            String headers = "";
            try
            {
                //Console.WriteLine("file path:" + file_path);
                PeFile pe_file_header = new PeFile(file_path);
                headers += pe_file_header.ImageNtHeaders.FileHeader.Machine + ", ";
                headers += pe_file_header.ImageNtHeaders.FileHeader.SizeOfOptionalHeader + ", ";
                headers += pe_file_header.ImageNtHeaders.FileHeader.Characteristics + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.MajorLinkerVersion + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.SizeOfInitializedData + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.MajorImageVersion + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.CheckSum + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.DllCharacteristics;
            }
            catch (System.Exception e)
            {
                //Console.WriteLine(e.Message);
                //return e.Message;
            }
            return headers;
        }

        private void log(string result, string file_name, string args, string path)
        {

            using (StreamWriter sw = File.AppendText(path))
            {
                sw.Write(file_name + " , " + args + ", " + result);
            }
        }

        private string cmd_run(string cmd, string args, string file_name)
        {
            //Console.WriteLine(file_name + "  " + args + "    --2");


            ProcessStartInfo start = new ProcessStartInfo();

            start.FileName = cmd;//cmd is full path to python.exe
            Console.WriteLine(file_name + "  " + args + "    --2");
            //start.Arguments = @"E:\Projects\BE_Project\ZecurePlus\ML\Model_4\classifier_call.py " + args;//args is path to .py file and any cmd line args
            start.Arguments = @"D:\College\BE\ZecurePlus\ML\Model_4\classifier_call.py " + args;//args is path to .py file nd any cmd line args
            //start.Arguments = @"D:\Anshul\BE_project\ZecurePlus\ML\Model_4\classifier_call.py " + args;//args is path to .py file and any cmd line args
            start.UseShellExecute = false;
            start.CreateNoWindow = true;
            start.RedirectStandardOutput = true;
            //Console.WriteLine(file_name + "  " + args + "    --3");
            //Console.WriteLine(cmd);
            using (Process process = Process.Start(start))
            {
                using (StreamReader reader = process.StandardOutput)
                {
                    string result = reader.ReadToEnd();
                    Console.WriteLine(file_name + " " + result);
                    log(result, file_name, args, @"D:\College\BE\ZecurePlus\logs\dev_log.txt");
                    //log(result, file_name, args, @" D:\Anshul\BE_project\ZecurePlus\logs\dev_log.txt");
                    //log(result, file_name, args, @"E:\Projects\BE_project\ZecurePlus\logs\dev_log.txt");

                    return (result.Trim());
                }
            }
        }
        public void update_json_file(int count)
        {
            Console.WriteLine(count);
            string json = File.ReadAllText("D:\\College\\BE\\ZecurePlus\\Dataset\\count.json");
            dynamic jsonObj = Newtonsoft.Json.JsonConvert.DeserializeObject(json);
            jsonObj["malware"] = count;
            string output = Newtonsoft.Json.JsonConvert.SerializeObject(jsonObj, Newtonsoft.Json.Formatting.Indented);
            File.WriteAllText("D:\\College\\BE\\ZecurePlus\\Dataset\\count.json", output);
        }
        public void FilePath(string filePath)
        {
            this.filePath.Text = filePath;
        }
        public void FileCount(int fileCount)
        {
            this.fileCount.Text = fileCount.ToString();
        }
        public void MalCount(int fileCount)
        {
            this.malwareCount.Text = fileCount.ToString();
        }

        private void DirSearch_ex3(string sDir)
        {
            string headers;
            string result;
            try
            {
                //Console.WriteLine(sDir);

                foreach (string f in Directory.GetFiles(sDir))
                {
                    try
                    {
                        updateFilePath UpdateFilePath = new updateFilePath(FilePath);
                        this.filePath.BeginInvoke(UpdateFilePath, f);
                        updateFileCount UpdateFileCount = new updateFileCount(FileCount);
                        this.fileCount.BeginInvoke(UpdateFileCount, count);
                        updateMalwareCount UpdateMalCount = new updateMalwareCount(MalCount);
                        this.malwareCount.BeginInvoke(UpdateMalCount, malware);
                        count += 1;
                        //Console.WriteLine($"{count}. {f}");
                        if (!PeFile.IsPEFile(f))
                        {
                            continue;
                        }
                        headers = get_header(f);
                        //Console.WriteLine(py_path +"    --1");
                        result = cmd_run(py_path, headers, f);

                        if (String.Equals(result, "malware", StringComparison.OrdinalIgnoreCase))
                        {
                            malware += 1;
                            dt.Rows.Add(new object[] { f, result });
                            dataGridView1.DataSource = dt;
                        }
                    }
                    catch (InvalidOperationException exc)
                    {
                        MessageBox.Show(exc.ToString());
                    }
                    catch (System.Exception excpt)
                    {
                        //Console.WriteLine(f + " --> Error " +excpt.Message);
                        continue;
                    }

                    //log(result, f, @"D:\College\BE\Project\ZecurePlus\logs\user_file.txt");

                }

                foreach (string d in Directory.GetDirectories(sDir))
                {
                    DirSearch_ex3(d);
                }
            }
            catch (System.Exception excpt)
            {
                //Console.WriteLine(excpt.Message);
            }
        }


        private void Full_System_Scan()
        {

            try
            {
                py_path = get_py_path();
                string[] drives = System.Environment.GetLogicalDrives();


                foreach (string dr in drives)
                {
                    //Console.WriteLine(dr);
                    DriveInfo di = new DriveInfo(dr);
                    //Console.WriteLine(di);


                    if (!di.IsReady)
                    {
                        Console.WriteLine("The drive {0} could not be read", di.Name);
                        continue;
                    }

                    DirectoryInfo root_dir = di.RootDirectory;

                    //Console.WriteLine(root_dir.ToString()+ "Root DIR");

                    DirSearch_ex3(root_dir.ToString());

                }
            }
            catch (System.Exception exct)
            {
                //Console.WriteLine(exct.Message);
                //return e.Message;
            }
            th.Abort();

        }

        private void startButton_Click(object sender, EventArgs e)
        {
            
            //Visibility of buttons
            startButton.Visible = false;
            pauseButton.Visible = true;
            stopButton.Visible = true;
            resumeButton.Visible = false;
            scanStatus.Text = "Scanning in Progress... ";
            count = 0;
            malware = 0;
            dt.Rows.Clear();
            dataGridView1.DataSource = dt;
            th = new Thread(Full_System_Scan);
            th.Start();
            th.IsBackground = true;
            
            
        }

        private void pauseButton_Click(object sender, EventArgs e)
        {
            scanStatus.Text = "The Scan has been Paused.";
            startButton.Visible = false;
            resumeButton.Visible = true;
            stopButton.Visible = true;
            pauseButton.Visible = false;
            if (th.IsAlive)
            {
                th.Suspend();
                Console.WriteLine("The Threat has been paused");
            }
            else
            {
                MessageBox.Show("No Scan in Running");
            }
        }

        private void resumeButton_Click(object sender, EventArgs e)
        {
            startButton.Visible = false;
            resumeButton.Visible = false;
            stopButton.Visible = true;
            pauseButton.Visible = true;
            scanStatus.Text = "Scanning in Progress... ";
            if (th.IsAlive)
            {
                th.Resume();
                Console.WriteLine("The Threat has been resumed");
            }
            else
            {
                MessageBox.Show("No Scan in Running");
            }
        }

        private void stopButton_Click(object sender, EventArgs e)
        {
            update_json_file(malware);
            startButton.Visible = true;
            pauseButton.Visible  = false;
            resumeButton.Visible = false;
            stopButton.Visible = false;
            scanStatus.Text = "Scan has been Stopped.";
            if (th != null)
            {
                Console.WriteLine(th.ThreadState);
                if (th.ThreadState == System.Threading.ThreadState.Running || th.ThreadState == System.Threading.ThreadState.Suspended || th.ThreadState == System.Threading.ThreadState.Background || th.ThreadState == System.Threading.ThreadState.Aborted)
                {

                    DialogResult dialog = MessageBox.Show("Do you really want to stop the scan?", "Stop the Scan", MessageBoxButtons.YesNo);
                    if (dialog == DialogResult.Yes)
                    {
                        th.Abort();

                    }
                }
            }
            else
            {
                MessageBox.Show("No scan was in progress.");
            }
            filePath.Text = "";
        }

        private void panel1_Paint(object sender, PaintEventArgs e)
        {

        }

        private void FullScanUserControl_Load(object sender, EventArgs e)
        {

        }

        private void fileName_Click(object sender, EventArgs e)
        {

        }

        private void startButton_MouseHover(object sender, EventArgs e)
        {
            startButton.BackColor = Color.FromArgb(178, 8, 55);
            startButton.ForeColor = Color.White;
        }

        private void button1_Click(object sender, EventArgs e)
        {
            update_json_file(malware);
            Form form = this.FindForm();
            //filePath.Text = "";
            //fileCount.Text = "";
            //malwareCount.Text = "";
            //scanStatus.Text = "";
            stopButton.Visible = false;
            pauseButton.Visible = false;
            resumeButton.Visible = false;
            startButton.Visible = true;

            if(th != null)
            {
                Console.WriteLine(th.ThreadState);
                if (th.ThreadState == System.Threading.ThreadState.Running || th.ThreadState == System.Threading.ThreadState.Suspended || th.ThreadState == System.Threading.ThreadState.Background )
                {
                    
                    DialogResult dialog = MessageBox.Show("Do you really want to stop the scan?", "Stop the Scan", MessageBoxButtons.YesNo);
                    if (dialog == DialogResult.Yes)
                    {
                        th.Abort();
                        form.Controls["malwareProtection1"].BringToFront();
                    }
                }
                else
                {
                    form.Controls["malwareProtection1"].BringToFront();
                }
            }
            else
            {
                form.Controls["malwareProtection1"].BringToFront();
            }
            filePath.Text = "";
            fileCount.Text = "";
            malwareCount.Text = "";
            //else if (dialog == DialogResult.Yes)
            //{
            //this.Close();
            //}
        }

        private void Status_Click(object sender, EventArgs e)
        {

        }
    }
}
