using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Security.Cryptography;
using System.IO;
using System.Threading;

namespace Antivirus
{
    public partial class VirusProtection : UserControl
    {
        public VirusProtection()
        {
            InitializeComponent();
        }
        // single file scan part
        Thread th;
        string file_path;

        // custom scan part 
        FolderBrowserDialog fbd = new FolderBrowserDialog();
        //Thread th;
        string custom_file_path;
        int count;

        //full scan part


        public string Get_MD5(string file_path)
        {
            using (var md5 = MD5.Create())
            {
                using (var stream = File.OpenRead(file_path))
                {
                    return BitConverter.ToString(md5.ComputeHash(stream)).Replace("-", string.Empty);
                }

            }
        }

        public bool check_hash(string md5_hash)
        {
            bool result = false;
            var md5_hashes = File.ReadAllLines("D:\\College\\BE\\ZecurePlus\\Dataset\\virus_scan_db.txt");
            //var md5_hashes = File.ReadAllLines("D:\\College\\BE\\ZecurePlus\\Dataset\\virus_db.txt"); //anish path
            //var md5_hashes = File.ReadAllLines("D:\\Projects\\BE_Project\\ZecurePlus\\Dataset\\virus_db.txt"); //jatin path
        
            if (md5_hashes.Contains(md5_hash))
            {
                result = true;
            }
            return result;
        }

        private void single_scan()
        {
            string md5_hash;
            md5_hash = Get_MD5(file_path);
            Console.WriteLine(check_hash(md5_hash));
            
        }

        private void single_file_scan_Click(object sender, EventArgs e)
        {
            Form form = this.FindForm();
            form.Controls["virusSingleScanUserControl1"].BringToFront();
            
            /*OpenFileDialog ofd = new OpenFileDialog();
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                file_path = ofd.FileName;
            }

            th = new Thread(single_scan);
            th.Start();
            th.IsBackground = true;*/
            
        }

        private void VirusProtection_Load(object sender, EventArgs e)
        {

        }

        private void label1_Click(object sender, EventArgs e)
        {

        }


        private void DirSearch_ex3(string sDir)
        {
            try
            {
                foreach (string f in Directory.GetFiles(sDir))
                {
                    count += 1;
                    string md5_hash;
                    md5_hash = Get_MD5(f);
                    Console.WriteLine(check_hash(md5_hash));
                }

                foreach (string d in Directory.GetDirectories(sDir))
                {
                    DirSearch_ex3(d);
                }
            }
            catch (System.Exception excpt)
            {
                Console.WriteLine(excpt.Message);
            }
        }

        private void start_custom_scan()
        {
            count = 0;
            DirSearch_ex3(custom_file_path);
            Console.WriteLine(count);
        }

        private void custom_file_scan_Click(object sender, EventArgs e)
        {

        }


        private void Full_System_Scan()
        {

            try
            {
                string[] drives = System.Environment.GetLogicalDrives();


                foreach (string dr in drives)
                {
                    //Console.WriteLine(dr);
                    DriveInfo di = new DriveInfo(dr);
                    //Console.WriteLine(di);


                    if (!di.IsReady)
                    {
                        Console.WriteLine("The drive {0} could not be read", di.Name);
                        continue;
                    }

                    DirectoryInfo root_dir = di.RootDirectory;

                    //Console.WriteLine(root_dir.ToString()+ "Root DIR");

                    DirSearch_ex3(root_dir.ToString());

                }
            }
            catch (System.Exception exct)
            {
                Console.WriteLine(exct.Message);
                //return e.Message;
            }
            th.Abort();

        }

        private void full_system_scan_Click(object sender, EventArgs e)
        {
            th = new Thread(Full_System_Scan);
            th.Start();
            th.IsBackground = true;
        }

        private void CustomScan_Click(object sender, EventArgs e)
        {
            Form form = this.FindForm();
            form.Controls["virusCustomScanUserControl1"].BringToFront();
        }

        private void FullSystemScan_Click(object sender, EventArgs e)
        {
            Form form = this.FindForm();
            form.Controls["virusFullScanUserControl1"].BringToFront();
        }
    }
}
