using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.IO;
using System.Security.Cryptography;
using System.Diagnostics;
using PeNet;
using PeNet.Utilities;
using Microsoft.IdentityModel.Tokens;

namespace Antivirus
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
            SelectPanel.Height = Home.Height;
            SelectPanel.Top = Home.Top;
            home1.BringToFront();

        }
        /*private int count = 0;
        string py_path = "";
        OpenFileDialog ofd = new OpenFileDialog();
        FolderBrowserDialog fbd = new FolderBrowserDialog();
        
        private void button1_Click(object sender, EventArgs e)
        {
            count = 0;
            String dir_path;
            
            
            if (fbd.ShowDialog() == DialogResult.OK)
            {
                dir_path = fbd.SelectedPath;
                py_path = get_py_path();
                DirSearch_ex3(dir_path);
                
            }
        }
        
        private void DirSearch_ex3(string sDir)
        {
            string headers;
            string result;
            try
            {
                //Console.WriteLine(sDir);

                foreach (string f in Directory.GetFiles(sDir))
                {
                    try
                    {
                        count += 1;
                        //Console.WriteLine($"{count}. {f}");
                        if (!PeFile.IsPEFile(f))
                        {
                            continue;
                        }
                        headers = get_header(f);
                        //Console.WriteLine(py_path +"    --1");
                        result = cmd_run(py_path, headers, f);
                    }
                    catch (InvalidOperationException exc)
                    {
                        MessageBox.Show(exc.ToString());
                    }
                    catch (System.Exception excpt)
                    {
                        //Console.WriteLine(f + " --> Error " +excpt.Message);
                        continue;
                    }
                    
                    //log(result, f, @"D:\College\BE\Project\ZecurePlus\logs\user_file.txt");

                }

                foreach (string d in Directory.GetDirectories(sDir))
                {
   
                    
                    DirSearch_ex3(d);
                }
            }
            catch (System.Exception excpt)
            {
                //Console.WriteLine(excpt.Message);
            }
        }

        private string get_py_path()
        {

            string temp_path="";
            string path="";
            Process cmd = new Process();
            cmd.StartInfo.FileName = "cmd.exe";
            cmd.StartInfo.RedirectStandardInput = true;
            cmd.StartInfo.RedirectStandardOutput = true;
            cmd.StartInfo.CreateNoWindow = true;
            cmd.StartInfo.UseShellExecute = false;
            cmd.Start();
            cmd.StandardInput.WriteLine("where python");
            cmd.StandardInput.Flush();
            cmd.StandardInput.Close();
            cmd.WaitForExit();
            while(!cmd.StandardOutput.EndOfStream )
            {
                string standard_output = cmd.StandardOutput.ReadLine();
                if(standard_output.Contains("python.exe"))
                {
                    temp_path = standard_output;
                    break;
                }

                
            }
            path = temp_path;
            
            return path;
          
        }

        private string get_header(String file_path)
        {
            String headers = "";
            try {
                //Console.WriteLine("file path:" + file_path);
                PeFile pe_file_header = new PeFile(file_path);
                headers += pe_file_header.ImageNtHeaders.FileHeader.Machine + ", ";
                headers += pe_file_header.ImageNtHeaders.FileHeader.SizeOfOptionalHeader + ", ";
                headers += pe_file_header.ImageNtHeaders.FileHeader.Characteristics + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.MajorLinkerVersion + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.SizeOfInitializedData + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.MajorImageVersion + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.CheckSum + ", ";
                headers += pe_file_header.ImageNtHeaders.OptionalHeader.DllCharacteristics;
            }
            catch (System.Exception e) {
                //Console.WriteLine(e.Message);
                //return e.Message;
            }
            return headers;
        }

        private string cmd_run(string cmd, string args, string file_name)
        {
            //Console.WriteLine(file_name + "  " + args + "    --2");
            
            
            ProcessStartInfo start = new ProcessStartInfo();
            
            start.FileName = cmd;//cmd is full path to python.exe
            Console.WriteLine(file_name + "  " + args + "    --2");
            //start.Arguments = @"E:\Projects\BE_Project\ZecurePlus\ML\Model_4\classifier_call.py " + args;//args is path to .py file and any cmd line args
            start.Arguments = @"D:\College\BE\Project\ZecurePlus\ML\Model_4\classifier_call.py " + args;//args is path to .py file and any cmd line args
            start.UseShellExecute = false;
            start.CreateNoWindow = true;
            start.RedirectStandardOutput = true;
            //Console.WriteLine(file_name + "  " + args + "    --3");
            //Console.WriteLine(cmd);
            using (Process process = Process.Start(start))
            {
                using (StreamReader reader = process.StandardOutput)
                {
                    string result = reader.ReadToEnd();
                    //Console.WriteLine(file_name + " " + result);
                    log(result, file_name, @"D:\College\BE\Project\ZecurePlus\logs\dev_log.txt");
                    return(result);
                }
            }
        }

        private void log(string result, string file_name, string path)
        {
        
            using (StreamWriter sw = File.AppendText(path))
            {
                sw.Write(file_name + " " + result);
            }
        }

        

        private void FullScan_Click(object sender, EventArgs e)
        {
            try
            {
                py_path = get_py_path();
                string[] drives = System.Environment.GetLogicalDrives();


                foreach (string dr in drives)
                {
                    //Console.WriteLine(dr);
                    DriveInfo di = new DriveInfo(dr);
                    //Console.WriteLine(di);


                    if (!di.IsReady)
                    {
                        Console.WriteLine("The drive {0} could not be read", di.Name);
                        continue;
                    }

                    DirectoryInfo root_dir = di.RootDirectory;

                    //Console.WriteLine(root_dir.ToString()+ "Root DIR");

                    DirSearch_ex3(root_dir.ToString());
                    break;
                }
            }
            catch (System.Exception exct)
            {
                //Console.WriteLine(exct.Message);
                //return e.Message;
            }
        }*/
        
        private void Home_Click(object sender, EventArgs e)
        {
            SelectPanel.Height = Home.Height;
            SelectPanel.Top = Home.Top;
            home1.BringToFront();
        }
        
        private void MalwareProtectionButton_Click(object sender, EventArgs e)
        {
            SelectPanel.Height = MalwareProtectionButton.Height;
            SelectPanel.Top = MalwareProtectionButton.Top;
            malwareProtection1.BringToFront();
        }

        private void VirusProtectionButton_Click(object sender, EventArgs e)
        {
            SelectPanel.Height = VirusProtectionButton.Height;
            SelectPanel.Top = VirusProtectionButton.Top;
            virusProtection1.BringToFront();
        }

        private void MinimizeButton_Click(object sender, EventArgs e)
        {
            if (this.WindowState != FormWindowState.Minimized)
            {
                this.WindowState = FormWindowState.Minimized;
            }
        }

        private void CloseButton_Click(object sender, EventArgs e)
        {
            DialogResult dialog = MessageBox.Show("Do you really want to exit the application", "Exit", MessageBoxButtons.YesNo);
            if (dialog == DialogResult.Yes)
            {
                Application.Exit();
            }
            else if (dialog == DialogResult.Yes)
            {
                this.Close();
            }
        }

        private void fullScanUserControl1_Load(object sender, EventArgs e)
        {

        }

        private void MaliciousUrlButton_Click(object sender, EventArgs e)
        {
            SelectPanel.Height = MaliciousUrlButton.Height;
            SelectPanel.Top = MaliciousUrlButton.Top;
            maliciousURL1.BringToFront();
            
        }
    }
}
