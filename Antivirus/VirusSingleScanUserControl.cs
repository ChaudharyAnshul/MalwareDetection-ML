using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Threading;
using System.Security.Cryptography;
using System.IO;

namespace Antivirus
{
    public partial class VirusSingleScanUserControl : UserControl
    {
        Thread th;
        string file_path;
        int virus = 0;
        public delegate void updateFilePath(string text);
        public delegate void updateFileStauts(string text);
        public VirusSingleScanUserControl()
        {
            InitializeComponent();
            stopB.Visible = false;
            startB.Visible = true;
            scanStatus.Text = "Please Click Start Button to Start the Scan.";
        }
        public void FilePath(string filePath)
        {
            //this.file.Text = filePath;
            this.fileP.Text = filePath;
        }
        public void FileStatus(string fileStatus)
        {
            //this.file.Text = filePath;
            this.status1.Text = fileStatus;
        }

        public string Get_MD5(string file_path)
        {
            using (var md5 = MD5.Create())
            {
                using (var stream = File.OpenRead(file_path))
                {
                    return BitConverter.ToString(md5.ComputeHash(stream)).Replace("-", string.Empty);
                }

            }
            
        }

        public bool check_hash(string md5_hash)
        {
            bool result = false;
            var md5_hashes = File.ReadAllLines("D:\\College\\BE\\ZecurePlus\\Dataset\\virus_scan_db.txt");
            //var md5_hashes = File.ReadAllLines("D:\\College\\BE\\ZecurePlus\\Dataset\\virus_db.txt"); //anish path
            //var md5_hashes = File.ReadAllLines("D:\\Projects\\BE_Project\\ZecurePlus\\Dataset\\virus_db.txt"); //jatin path

            if (md5_hashes.Contains(md5_hash))
            {
                result = true;
                virus += 1;
            }
            return result;
        }

        private void single_scan()
        {
            string md5_hash;
            md5_hash = Get_MD5(file_path);
            bool result = check_hash(md5_hash);
            updateFilePath UpdateFilePath = new updateFilePath(FilePath);
            this.fileP.BeginInvoke(UpdateFilePath, file_path);
            updateFileStauts UpdateFileStatus = new updateFileStauts(FileStatus);
            string rslt = "Benign"; 
            if(result.ToString() == "True")
            {
                rslt = "Virus";
            }
            this.status1.BeginInvoke(UpdateFileStatus, rslt);
            th.Abort();
        }

        private void startB_Click(object sender, EventArgs e)
        {
            //Visibility of buttons
            startB.Visible = false;
            stopB.Visible = true;
            scanStatus.Text = "Scanning in Progress... ";
            OpenFileDialog ofd = new OpenFileDialog();
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                file_path = ofd.FileName;
            }

            th = new Thread(single_scan);
            th.Start();
            th.IsBackground = true;
            
            
        }

        private void stopB_Click(object sender, EventArgs e)
        {
            update_json_file(virus);
            startB.Visible = true;
            stopB.Visible = false;
            scanStatus.Text = "Scan has been Stopped.";
            if (th != null)
            {
                Console.WriteLine(th.ThreadState);
                if (th.ThreadState == System.Threading.ThreadState.Running || th.ThreadState == System.Threading.ThreadState.Suspended || th.ThreadState == System.Threading.ThreadState.Background || th.ThreadState == System.Threading.ThreadState.Aborted)
                {

                    DialogResult dialog = MessageBox.Show("Do you really want to stop the scan?", "Stop the Scan", MessageBoxButtons.YesNo);
                    if (dialog == DialogResult.Yes)
                    {
                        th.Abort();

                    }
                }
            }
            else
            {
                MessageBox.Show("No scan was in progress.");
            }
            fileP.Text = "";
        }

        private void button1_Click(object sender, EventArgs e)
        {
            update_json_file(virus);
            Form form = this.FindForm();
            stopB.Visible = false;
            startB.Visible = true;
            if (th != null)
            {
                Console.WriteLine(th.ThreadState);
                if (th.ThreadState == System.Threading.ThreadState.Running || th.ThreadState == System.Threading.ThreadState.Suspended || th.ThreadState == System.Threading.ThreadState.Background)
                {

                    DialogResult dialog = MessageBox.Show("Do you really want to stop the scan?", "Stop the Scan", MessageBoxButtons.YesNo);
                    if (dialog == DialogResult.Yes)
                    {
                        th.Abort();
                        form.Controls["virusProtection1"].BringToFront();
                    }
                }
                else
                {
                    form.Controls["virusProtection1"].BringToFront();
                }
            }
            else
            {
                form.Controls["virusProtection1"].BringToFront();
            }
            fileP.Text = "";
            status1.Text = "";
        }
        public void update_json_file(int count)
        {
            Console.WriteLine(count);
            string json = File.ReadAllText("D:\\College\\BE\\ZecurePlus\\Dataset\\count.json");
            dynamic jsonObj = Newtonsoft.Json.JsonConvert.DeserializeObject(json);
            jsonObj["virus"] = count;
            string output = Newtonsoft.Json.JsonConvert.SerializeObject(jsonObj, Newtonsoft.Json.Formatting.Indented);
            File.WriteAllText("D:\\College\\BE\\ZecurePlus\\Dataset\\count.json", output);
        }
    }
}
